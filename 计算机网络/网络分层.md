# 网络分层

## 网络分层模型

标准的七层网络分层，就是OSI七层模型，TCP/IP五层模型和TCP/IP四层模型都是从OSI七层模型优化而来。

![网络分层模型](/计算机网络/img/网络分层模型.webp)

**为什么需要分层？**

一个好的分层式结构，可以使得开发人员得分工更加明确。如果一个系统没有分层，那么各自的逻辑都紧紧纠缠在一起，彼此之间相互依赖，谁都是不可替代的；一旦发生改变，牵一发而动全身，对系统影响极为严重。

在计算机网络得基本概念中，分层次得体系结构是最基本的。分层的主要好处有：

- 各层之间是独立的，每一层向上和向下通过层间接口提供服务，无需暴露内部实现
- 灵活性好
- 结构上可分割
- 易于实现和维护
- 能促进标准化工作

### 网络分层与协议

每一层的分层中，都有对应的协议。

![网络分层与协议](/计算机网络/img/网络分层与协议.webp)

## 物理层

物理层上所传输的数据单位是比特，物理层的任务就是透明的传送比特流。因此物理层需要考虑如何用电压表示“1”或“0”，以及接收方如何识别出这些比特流。物理层不包括具体的传输媒介，但是需要确定**链接电缆的插头标准**。

物理层协议主要是标准化工作频段、传输速率、电信号、传输媒体插口标准等。

### 物理层硬件设备

- 集线器：本质是中继器，对接收到的信号进行再生放大，以扩大网络的传递距离。集线器可以将局域网内的所有电脑集中在以它为中心的节点上连接起来，数据是以广播的形式从一台电脑传送到其他的电脑。广播会产生冲突，同一个时间点只有一台电脑可发送数据。所以效率比较低。集线器不具有学习功能，也不具备MAC地址表。
- 中继器：又称重发器，是一种最为简单但也是用得最多的互连设备。中继器仅适用于以太网，可将两段或两段以上以太网互连起来。常用于两个网络节点之间物理信号的双向转发工作。中继器主要完成物理层的功能，负责在两个节点的物理层上按位传递信息，完成信号的复制、调整和放大功能，以此来延长网络的长度。

## 数据链路层

单纯的电信号0和1并没有任何意义，必须规定电信号多少位一组，每组什么意思。以太网协议规定，一组电信号构成一个数据包，这个数据包称之为帧。每一个帧由包头（Head）和数据（Data）两部分组成，Head包含数据包的一些说明信息，包括发送者、接收者、数据类型；Data则是数据包的具体内容。

Head部分包含固定18个字节：

- 发送者/源地址，6个字节
- 接收者/目标地址，6个字节
- 数据类型，6个字节

Data部分长度最短为46字节，最长为1500字节。如果数据很好，就必须分割成多帧发送。

### MAC地址

以太网规定，连入网络的所有设备都必须具有网卡。数据包的发送地址和接收地址就是网卡地址，也就是MAC地址。MAC地址作为网络中计算机设备的唯一标识，从计算机在厂商生产出来就被十六进制的数标识为MAC地址，MAC地址理论上是独一无二的。MAC地址长度为48位2进制，通常由12位16进制数标识（前六位是厂商编号，后六位是流水线号）.

有了MAC地址，在同一网络内的两台主机就可以通信。当计算机接收到数据包时，会把MAC地址取出来与本身的MAC做比较，相同则接受，不同则抛弃。

### 数据链路层硬件设备

- 适配器（网卡）：包含处理器和存储器，拥有理论上独一无二的MAC地址。具有功能：缓存数据帧、数据包封装成帧、检测网络通道是否为空、检测通道是否有碰撞、过滤MAC地址（广播通知时，根据MAC地址判断是否接受数据帧）。
- 网桥：由于集线器的广播机制，当单一网络内的节点过多的时候，冲突比较明显，效率就明显降低。所以需要一个硬件能够将网络分割成多个较小的网络，让广播仅限于局部。所以网桥就诞生了。网桥可以隔离俩个网络，相当于有俩个端口A、B。A端口和B端口会自动记录和他端口相连接的集线器上的所有节点的MAC地址。这样往A端口上的节点发送的数据包就不会再B端口连接的网络上进行广播了，从而达到减少广播冲突的的目的，提高了效率。

  ![网桥模型](/计算机网络/img/网桥模型.jpg)

- 交换机：网桥只有两个端口。随着网络设备的发展，逐渐产生了多个端口的“网桥”，但是由于网桥是数据链路层的广播通信，集线器是物理层的广播通知，A和G通信的时候，C和D就无法通行，B和F就没法通信——一个桥上、一个集线器上多个通信将产生冲突。为了能够实现多对多的通信，于是产生了交换机。
  - 交换机存在多个端口，逐渐替换了集线器、网桥，成为了组建局域网的核心设备。交换机工作于OSI7层中的数据链路层。交换机会通过ARP协议学习他的MAC地址，保存成一张ARP表。 在今后的通讯中，发往该MAC地址的数据包将仅送往其对应的端口，而不是所有的端口。因此，交换机可用于划分数据链路层广播，即冲突域；但它不能划分网络层广播，即广播域。 也就是说，交换机也有一张表，记录的是port-mac，网络层维护的是ip-mac对应表。

  ![交换机模型](/计算机网络/img/交换机模型.jpg)

## 网络层

以太网采用广播（向网络中所有计算机发送数据包）方式发送数据包，效率低且发送的数据只能局限在发送者所在的网络。想要组建更大的网络（互联网等）必须依靠网络层的路由器以及IP协议，网络层负责为不同网络上的不同主机提供通信服务，网络层将传输数据组装成IP数据报在网络上传输。

### IP协议

IP协议地址（网络地址协议）。相对于MAC地址，IP地址可理解为逻辑地址，MAC地址是物理上的地址，是固定的；IP地址是动态分配的，是不固定的。目前广泛采用IPv4地址，IPv6也在迅猛发展。

IP协议发送的数据叫做数据包，也分为“包头”和“数据两部分”：“包头”部分主要包括版本、长度、IP地址等信息；“数据”则是IP数据包的具体内容。“包头”长度为20-60字节，整个数据包总长度最大为65535字节。

IPv4地址是由32为二进制数组成，一般分成4段的十进制表示，就是给因特网上每一个主机或者路由器的每一个接口提供一个在全世界范围内唯一的32位标识符。地址范围为0.0.0.0~255.255.255.255。IP地址分为两部分：网络部分（标识子网）和主机部分（标识主机）。网络部分和主机部分所占用的二进制位数需要根据子网掩码确定。

### 子网掩码

根据RFC950定义，子网掩码是一个32位的2进制数， 其对应网络地址的所有位都置为1，对应于主机地址的所有位置都为0。子网掩码告知路由器，地址的哪一部分是网络地址，哪一部分是主机地址，使路由器正确判断任意IP地址是否是本网段的，从而正确地进行路由。

子网掩码的设定必须遵循一定的规则。与二进制IP地址相同，子网掩码由1和0组成，且1和0分别连续。子网掩码的长度也是32位，左边是网络位，用二进制数字“1”表示，1的数目等于网络位的长度；右边是主机位，用二进制数字“0”表示，0的数目等于主机位的长度。

有了IP地址与子网掩码，那么只需要将IP分别与子网掩码做**按位与**操作，得出来的结果相同，就代表它们在一个子网内，可以进行通信；否则并不能，即代表不在同一局域网中。

一个主机192.168.1.199/26 能否和直连主机192.168.1.200/24 通信？

192.168.1.199/26代表IP地址为192.168.1.199，子网掩码为11111111.11111111.11111111.11000000，即26位的网络地址；192.168.1.200/24代表IP地址为192.168.1.200，子网掩码为11111111.11111111.11111111.00000000，即24位的网络地址。在192.168.1.199/26看来，它只知道自己的子网掩码：26位网络地址的子网掩码11111111.11111111.11111111.11000000，分别将IP地址192.168.1.199、192.168.1.200与子网掩码/26做按位与操作，得出相同的结果192.168.1.192

反之在192.168.1.200/24看来，它只知道自己的子网掩码：24位网络地址的子网掩码11111111.11111111.11111111.00000000，分别将IP地址192.168.1.199、192.168.1.200与子网掩码/24做按位与操作，得出相同的结果192.168.1.0

因此，它们互相与自己的子网掩码做计算都能得到相同的操作，就代表它们在同一局域网内（逻辑上，不管实际物理情况），可以进行直连。

### ARP协议

有了IP协议，可以判断计算机属于哪个子网。在链路层时我们通过MAC地址进行通信，现在只有目标IP地址，通过ARP协议就可以知道对应的MAC地址。工作原理为：

- 当有新设备加入网路时，会主动广播自己的MAC与IP
- 当接收到新设备的信息时，本机建立一张对照表维护这个信息
- 当需要发送数据报给一个IP时，到建立好的表中查询对应的MAC并发送。当查询不到信息时，广播一个查询申请，要求指定IP主机执行第一步操作，并在稍后重新执行本步骤。

IP数据报在网络层传输的过程中源IP地址和目标IP地址是一直不变的，但是源MAC地址和目标MAC每经过一个网络节点就要更换，所以在每个网络节点的转发过程中都会用到ARP协议。

### ICMP协议

ICMP（Internet Control Message Protocol 因特网控制报文协议）是网络层另外一个重要的协议。它是IP协议的重要补充，主要用于检测网络连接。ICMP报文分为两大类：一类是差错报文，主要用来回应网络错误，比如目标不可达（类型值为3）和重定向（类型值为5）；另一类是查询报文，这类报文用来查询网络信息，比如ping程序就是使用ICMP报文查看目标是否可到达（类型值为8）.

### 网络层相关硬件

- 路由器：路由器是一种有多个输入端口和多个输出端口的专用计算机。他只支持网络层、数据链路层、物理层三层协议，其主要作用就是转发IP数据报。为了转发IP数据报，路由器需要维护一个路由表根据不同的IP地址确定不同的端口，将IP数据报转发到不同的网络中。
- NAT路由器：NAT:网络地址转换(Network Address Translation）,装有NAT软件的路由器叫做NAT路由器。
内网主机想要与互联网上的主机进行交互通讯时可通过NAT路由器，起作用是将内网IP转换为一个互联网IP。![NAT路由器](/计算机网络/img/NAT路由器.png)

## 传输层

传输层负责两个主机之间进程的通信，网络层负责主机之间的通信。当IP数据报发送给另外一台主机后运输层负责将消息发送给具体的进程也就是不同的应用程序，同理应用层的应用程序在不同主机上需要进行通信时，必须依赖运输层。

计算机上运行的不同应用程序会分配不同的端口，而传输层就是建立端口到端口的通信，使得数据能够正确的传送给不同的应用程序。端口号是0到65535之间的一个整数，正好16个二进制位，0-1023为系统占用端口，其他应用程序只能选用大于1023的端口。至此，用IP + 端口，已经能实现唯一确定互联网上一个程序，进而实现网络间的程序通信了。

传输层最常见的两大协议是 TCP（Transmission Control Protocol，传输控制协议） 协议和 UDP（User Data Protocol，用户数据报协议） 协议。

TCP传输控制协议

- TCP协议是面向连接的,建立连接需要经过三次握手，释放链接需要经过四次挥手；
- TCP协议两端链接的是俩个端点，这俩个端点叫做套接字（socket） socket = ip:port;
- 提供可靠交付的协议,保证数据段在传输过程中无差错、不丢失、不重复、按照顺序到达（依赖重传和编号机制），且可以根据网络信道的拥塞情况，动态的调整发送窗口的大小，缓解网络堵塞的情况；
- TCP协议是面向流的，应用层要使用TCP协议，必须有字节流的处理能力，数据传输单位是报文段；
- 提供全双工通信，任何时候双方都可以进行发送和接收数据。

UDP用户数据报协议

- UDP协议不需要建立连接，即在发送数据之前不需要建立连接；
- 只尽最大努力交付，但不保证成功；
- 数据传输的单位是用户数据报，UDP将应用层传递下来的数据报，加上UPD协议的头部和尾；部之后完整的交给网络层，不做合并与拆分；
- UDP没有拥塞控制，不能根据网络通道的堵塞情况，动态的调整数据报的大小；
- UDP协议支持一对一、一对多、多对多通信；
- UDP协议首部字节数据较小，只占用了8个字节，相对TCP的20个字节，小了很多。

## 应用层

应用层是OSI7层协议中的最高层，也是离计算机普通用户最近的一层，应用层直接为应用程序经常提供服务。在互联网中有很多应用层协议。

- TELNET：远程终端协议，一般用于端口联通性测试；
- FTP：文件传输协议，使用的是TCP协议进行数据传输，一般占用21端口；
- TFTP：简单文件传输协议，使用的是UDP协议进行数据传输，默认端口为69；
- HTTP：超文本传送协议，浏览器使用的协议，默认端口为80
- Telnet：远程登录协议
- DNS：域名解析协议，提供机器域名到IP地址的转换
- SMTP：邮件传送协议，一般25端口
- POP3：邮局协议

## 封装

上层协议如何使用下层协议提供的服务？都是通过封装（encapsulation）实现的。应用程序数据在发送到物理网络上之前，将沿着协议栈从上往下依次传递。每层协议都将在上层数据的基础上加上自己的头部信息（有时还包括尾部信息），以实现该层的功能，这个过程就成为封装。

![网络分层-数据封装](/计算机网络/img/网络分层-数据封装.png)

经过TCP封装后的数据称为TCP报文段（TCP message segment），或者简称TCP段。TCP通信为通信双方维持一个连接，并且在内核中存储相关的数据，这部分数据中的TCP头部信息和TCP内核缓冲区（发送缓冲区或接收缓冲区）数据一起构成了TCP报文段。

![tcp报文段封装过程](/计算机网络/img/tcp报文段封装过程.png)

经过UDP封装后的数据称为UDP数据报（UDP datagram）。UDP对应用程序数据的封装与TCP类似。不同的是，UDP无需为应用层数据保存副本，因为它提供的服务是不可靠的。当一个UDP数据报被成功发送之后，UDP内核缓冲区中的该数据报就被丢弃了。如果应用程序检测到该数据报未能被接收端正确接收，并打算重发这个数据报，则应用程序需要重新从用户空间将该数据报拷贝到UDP内核发送缓冲区中。

经过IP封装后的数据称为IP数据报（IP datagram）。IP数据报也包括头部信息和数据部分，其中数据部分就是一个TCP报文段、UDP报文段或者ICMP报文。

经过数据链路层封装的数据称为帧（frame）。传输媒介不同，帧的类型也不同。例如，以太网上传输的是以太网帧（ethernet frame），而令牌环网络上传输的则是令牌环帧（token ring frame）。

以以太网帧为例，以太网帧使用6字节的目的物理地址（MAC地址）和6字节的源物理地址（MAC地址）来表示通信的双方。关于类型（type）字段，主要是在以太网中传输不同类型的协议数据时，为这些数据提供一个唯一的标识符。字节CRC字段对帧的其他部分提供循环冗余校验。

![以太网帧封装](/计算机网络/img/以太网帧封装.png)

帧才是最终在物理网络上传送的字节序列。至此，封装过程完成。

## 分用

当帧到达目的主机时，将沿着协议栈自底向上依次传递。各层协议依次处理帧中本层负责的头部数据，以获取所需的信息，并将最终处理后的帧交给目标应用程序。这个过程称为分用（demultiplexing）。分用是依靠头部信息中的类型字段实现的。

![以太网帧的分用过程](/计算机网络/img/以太网帧的分用过程.png)

因为IP协议、ARP协议和RARP协议都是用帧传输数据，所以帧的头部需要提供某个字段来区分它们。以以太网帧为例，它使用2字节的类型（type）字段标识上层协议。如果主机接收到的以太网帧类型字段值为0x800，则帧的数据部分为IP数据报，以太网驱动程序就将帧交付给IP模块；若类型字段值为0x806，则帧的数据部分为ARP请求或应答报文，以太网驱动程序就将帧交付给ARP模块；若字段的值为0x835，则帧的数据部分为RARP请求或应答报文，以太网驱动程序就将帧交付给RARP模块。

同样，因为ICMP协议、TCP协议、UDP协议都是用IP协议，所以IP数据报的头部采用16位的协议（protocol）字段来区分它们。

TCP报文段和UDP数据报则通过其头部中的16位端口号（port number）字段来区分上层应用程序。比如DNS协议对应端口号是53，HTTP协议（Hyper-Text Transfer Protocol，超文本传输协议）对应端口号是80.所有知名应用层协议使用的端口号都可以在/etc/services文件中找到。

帧通过上述分用步骤后，最终将封装前的原始数据送至目标服务。这样，在顶层目标服务看来，封装和分用似乎没有发生过。

## 参考图

![参考图](/计算机网络/img/网络分层参考图.gif)

## 参考

- [网络分层体系结构](https://www.cnblogs.com/zhouxiangting/p/10651641.html)
- [一篇文章，只用看三遍，终生不忘网络分层](https://zhuanlan.zhihu.com/p/380119935)
- Linux高性能服务器编程